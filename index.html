import React, { useState, useEffect, useRef, useCallback } from 'react';
import { 
  Heart, Shield, Play, Volume2, VolumeX,
  Truck, Building2, Cpu, Coins, XCircle, 
  ArrowUpCircle, Ghost, Skull, Bug, Hand, Zap,
  Flame, Gem, TrendingUp, Anchor, Briefcase, MapPin, Users,
  Bot, CloudLightning, ShoppingBag, Utensils
} from 'lucide-react';

// --- Game Constants ---
const GRID_W = 20;
const GRID_H = 12;

// Path Definitions
const PATH_LEFT = [
  {x:0, y:5}, {x:1, y:5}, {x:2, y:5}, {x:3, y:5}, {x:4, y:5}, 
  {x:5, y:5}, {x:5, y:4}, {x:5, y:3}, {x:6, y:3}, {x:7, y:3},
  {x:8, y:3}, {x:9, y:3}, {x:10, y:3}, {x:10, y:4}, {x:10, y:5},
  {x:11, y:5}, {x:12, y:5}, {x:13, y:5}, {x:14, y:5}, {x:15, y:5},
  {x:16, y:5}, {x:17, y:5}, {x:18, y:5}, {x:19, y:5}
];
const PATH_TOP = [
  {x:8, y:0}, {x:8, y:1}, {x:8, y:2}, {x:8, y:3}, 
  {x:9, y:3}, {x:10, y:3}, {x:10, y:4}, {x:10, y:5}, 
  {x:11, y:5}, {x:12, y:5}, {x:13, y:5}, {x:14, y:5}, {x:15, y:5},
  {x:16, y:5}, {x:17, y:5}, {x:18, y:5}, {x:19, y:5}
];
const PATH_BOTTOM = [
  {x:12, y:11}, {x:12, y:10}, {x:12, y:9}, {x:12, y:8}, {x:12, y:7},
  {x:12, y:6}, {x:12, y:5}, 
  {x:13, y:5}, {x:14, y:5}, {x:15, y:5},
  {x:16, y:5}, {x:17, y:5}, {x:18, y:5}, {x:19, y:5}
];
const ALL_PATHS = [PATH_LEFT, PATH_TOP, PATH_BOTTOM];

// Types
type TowerType = 'logistics' | 'finance' | 'tech';
type EnemyType = 'ghost' | 'skull' | 'bug' | 'flame' | 'boss' | 'bat' | 'robot';
type GameState = 'menu' | 'quiz' | 'playing' | 'gameover' | 'victory';

interface Enemy {
  id: number;
  pathId: number;
  pathIndex: number;
  progress: number;
  hp: number;
  maxHp: number;
  speed: number;
  type: EnemyType;
  frozen?: number;
  visualOffset: number; 
}

interface Tower {
  id: number;
  x: number;
  y: number;
  type: TowerType;
  level: number;
  damage: number;
  range: number;
  cooldown: number;
  lastFired: number;
}

interface Projectile {
  id: number;
  x: number;
  y: number;
  targetId: number;
  speed: number;
  damage: number;
  type: 'box' | 'coin' | 'laser';
  startX?: number; 
  startY?: number; 
}

interface Particle {
  id: number;
  x: number;
  y: number;
  life: number;
  color: string;
}

// --- AUDIO ENGINE ---
const AudioEngine = {
  ctx: null as AudioContext | null,
  isMuted: false,
  init: () => { if (!AudioEngine.ctx) AudioEngine.ctx = new (window.AudioContext || (window as any).webkitAudioContext)(); },
  playTone: (freq: number, type: OscillatorType, duration: number, vol: number = 0.1) => {
    if (AudioEngine.isMuted || !AudioEngine.ctx) return;
    const osc = AudioEngine.ctx.createOscillator();
    const gain = AudioEngine.ctx.createGain();
    osc.type = type;
    osc.frequency.setValueAtTime(freq, AudioEngine.ctx.currentTime);
    gain.gain.setValueAtTime(vol, AudioEngine.ctx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.01, AudioEngine.ctx.currentTime + duration);
    osc.connect(gain);
    gain.connect(AudioEngine.ctx.destination);
    osc.start();
    osc.stop(AudioEngine.ctx.currentTime + duration);
  },
  playShoot: () => AudioEngine.playTone(400, 'square', 0.1, 0.05),
  playHit: () => AudioEngine.playTone(100, 'sawtooth', 0.1, 0.05),
  playBuild: () => AudioEngine.playTone(600, 'sine', 0.2, 0.1),
  playWin: () => { [523.25, 659.25, 783.99, 1046.50].forEach((f, i) => setTimeout(() => AudioEngine.playTone(f, 'square', 0.3, 0.1), i * 100)); },
  toggleMute: () => { AudioEngine.isMuted = !AudioEngine.isMuted; return AudioEngine.isMuted; }
};

// --- BILINGUAL QUESTION BANK (30 Questions) ---
// Note: Options now include both Chinese and English text.
const FULL_QUESTION_BANK = [
  // --- Industry Matching ---
  { id: 1, qZh: "「我負責帶客人四處觀光」，我是從事？", qEn: "I take guests sightseeing.", options: [{t:"旅遊業 (Tourism)",c:true}, {t:"飲食業 (Catering)",c:false}, {t:"保險業 (Insurance)",c:false}], expl: "導遊屬於旅遊業 (Tour guide belongs to Tourism)." },
  { id: 2, qZh: "「我銷售不同類型的保險產品」，我是從事？", qEn: "I sell insurance products.", options: [{t:"金融服務業 (Financial)",c:true}, {t:"零售業 (Retail)",c:false}, {t:"酒店業 (Hotel)",c:false}], expl: "保險是金融服務 (Insurance is Financial Service)." },
  { id: 3, qZh: "「我在提供兌換外幣服務的店舖工作」，我是從事？", qEn: "I work in currency exchange.", options: [{t:"金融服務業 (Financial)",c:true}, {t:"物流業 (Logistics)",c:false}, {t:"旅遊業 (Tourism)",c:false}], expl: "外匯買賣屬於金融服務 (Forex is Financial Service)." },
  { id: 4, qZh: "「我替客人辦理酒店入住手續」，我是從事？", qEn: "I handle hotel check-ins.", options: [{t:"酒店業 (Hotel)",c:true}, {t:"零售業 (Retail)",c:false}, {t:"飲食業 (Catering)",c:false}], expl: "這是酒店前台工作 (Hotel Front Desk)." },
  { id: 5, qZh: "「我負責為客人烹調美食」，我是從事？", qEn: "I cook for guests.", options: [{t:"飲食業 (Catering)",c:true}, {t:"零售業 (Retail)",c:false}, {t:"物流業 (Logistics)",c:false}], expl: "廚師屬於飲食業 (Chefs are in Catering)." },
  { id: 6, qZh: "「我負責向客人銷售貨品」，我是從事？", qEn: "I sell goods to customers.", options: [{t:"零售業 (Retail)",c:true}, {t:"旅遊業 (Tourism)",c:false}, {t:"保險業 (Insurance)",c:false}], expl: "售貨員屬於零售業 (Salesperson is Retail)." },

  // --- Logistics True/False ---
  { id: 7, qZh: "以下哪項 **屬於** 物流業的服務？", qEn: "Which IS a logistics service?", options: [{t:"倉務管理 (Warehousing)",c:true}, {t:"生產貨物 (Production)",c:false}, {t:"售賣貨品 (Selling)",c:false}], expl: "倉務是物流核心 (Warehousing is core)." },
  { id: 8, qZh: "以下哪項 **屬於** 物流業的服務？", qEn: "Which IS a logistics service?", options: [{t:"運送貨品 (Transport)",c:true}, {t:"製造產品 (Manufacturing)",c:false}, {t:"種植食材 (Farming)",c:false}], expl: "運輸是物流一環 (Transport is Logistics)." },
  { id: 9, qZh: "以下哪項 **不屬於** 物流業的服務？", qEn: "Which is NOT logistics?", options: [{t:"生產貨物 (Production)",c:true}, {t:"包裝 (Packaging)",c:false}, {t:"貼標籤 (Labeling)",c:false}], expl: "物流不負責生產 (Logistics isn't Production)." },
  { id: 10, qZh: "以下哪項 **不屬於** 物流業的服務？", qEn: "Which is NOT logistics?", options: [{t:"售賣貨品 (Selling)",c:true}, {t:"存貨管理 (Inventory)",c:false}, {t:"運送 (Delivery)",c:false}], expl: "售賣屬於零售業 (Selling is Retail)." },

  // --- Challenges & Solutions ---
  { id: 11, qZh: "物流業面對甚麼挑戰？", qEn: "Challenge for logistics?", options: [{t:"人手短缺 (Labor Shortage)",c:true}, {t:"貨物太多 (Too many goods)",c:false}, {t:"沒有機場 (No airport)",c:false}], expl: "人手短缺是主要挑戰 (Labor shortage is key)." },
  { id: 12, qZh: "政府如何解決物流用地不足？", qEn: "Solution for land shortage?", options: [{t:"增加物流用地 (More Land)",c:true}, {t:"減少進口 (Less Imports)",c:false}, {t:"關閉碼頭 (Close Port)",c:false}], expl: "政府增加物流用地 (Gov provides land)." },
  { id: 13, qZh: "業界如何應對人手短缺？", qEn: "Solution for labor shortage?", options: [{t:"推動自動化 (Automation)",c:true}, {t:"聘請外星人 (Hire Aliens)",c:false}, {t:"停止運作 (Stop Work)",c:false}], expl: "應用科技代替人力 (Tech replaces labor)." },

  // --- Infrastructure & GBA ---
  { id: 14, qZh: "連接香港與深圳的第七個陸路口岸是？", qEn: "7th land crossing to Shenzhen?", options: [{t:"蓮塘／香園圍 (Liantang)",c:true}, {t:"羅湖 (Lo Wu)",c:false}, {t:"落馬洲 (Lok Ma Chau)",c:false}], expl: "蓮塘是新口岸 (Liantang is new)." },
  { id: 15, qZh: "港珠澳大橋連接哪三個城市？", qEn: "HZMB connects?", options: [{t:"港珠澳 (HK-Zhuhai-Macao)",c:true}, {t:"港深廣 (HK-SZ-GZ)",c:false}, {t:"港台日 (HK-TW-JP)",c:false}], expl: "連接香港、珠海、澳門。" },
  { id: 16, qZh: "廣深港高鐵香港段總站在哪？", qEn: "HSR Terminus location?", options: [{t:"西九龍 (West Kowloon)",c:true}, {t:"紅磡 (Hung Hom)",c:false}, {t:"沙田 (Sha Tin)",c:false}], expl: "位於西九龍 (Located in West Kowloon)." },
  { id: 17, qZh: "大灣區包括香港、澳門和哪個省的城市？", qEn: "GBA includes HK, Macao and?", options: [{t:"廣東省 (Guangdong)",c:true}, {t:"福建省 (Fujian)",c:false}, {t:"廣西省 (Guangxi)",c:false}], expl: "包括廣東城市 (Guangdong cities)." },
  { id: 18, qZh: "中國內地為香港提供甚麼優勢？", qEn: "Mainland provides HK?", options: [{t:"科研配套及市場 (Tech/Market)",c:true}, {t:"國際法律意見 (Intl Law)",c:false}, {t:"自由港政策 (Free Port)",c:false}], expl: "內地有設施和市場 (Facilities & Market)." },
  { id: 19, qZh: "香港為中國內地提供甚麼？", qEn: "HK provides Mainland?", options: [{t:"專業服務(金融) (Pro Services)",c:true}, {t:"工廠用地 (Factory Land)",c:false}, {t:"廉價原材料 (Cheap Material)",c:false}], expl: "提供資金、法律等服務 (Capital & Law)." },

  // --- Emerging Industries ---
  { id: 20, qZh: "手機程式開發員屬於哪個行業？", qEn: "App developer belongs to?", options: [{t:"新興行業 (Emerging Ind.)",c:true}, {t:"傳統農業 (Agriculture)",c:false}, {t:"採礦業 (Mining)",c:false}], expl: "這是創新科技 (Innovation & Tech)." },
  { id: 21, qZh: "生物醫學研究助理主要負責甚麼？", qEn: "Biomedical assistant does?", options: [{t:"醫學測試及分析 (Analysis)",c:true}, {t:"銷售藥物 (Selling Drugs)",c:false}, {t:"醫院清潔 (Cleaning)",c:false}], expl: "進行測試及分析 (Testing & Analysis)." },
  { id: 22, qZh: "發展創新科技需要甚麼能力？", qEn: "Skills for InnoTech?", options: [{t:"電腦/分析能力 (Comp/Analysis)",c:true}, {t:"體力勞動 (Physical Labor)",c:false}, {t:"只懂抄寫 (Copying)",c:false}], expl: "需要科技知識 (Tech knowledge)." },
  { id: 23, qZh: "為何要發展新興行業？", qEn: "Why develop new industries?", options: [{t:"經濟多元化 (Diversification)",c:true}, {t:"放棄舊行業 (Abandon Old)",c:false}, {t:"減少就業 (Reduce Jobs)",c:false}], expl: "經濟多元化發展 (Diverse Economy)." },

  // --- General Economy ---
  { id: 24, qZh: "香港缺乏天然資源，食品主要依靠？", qEn: "HK relies on what for food?", options: [{t:"進口 (Imports)",c:true}, {t:"出口 (Exports)",c:false}, {t:"自家耕種 (Farming)",c:false}], expl: "依靠進口 (Relies on imports)." },
  { id: 25, qZh: "將外地貨品經香港賣給其他地方是？", qEn: "Selling via HK to others?", options: [{t:"轉口貿易 (Re-export)",c:true}, {t:"本地消費 (Local)",c:false}, {t:"直接出口 (Direct Export)",c:false}], expl: "這是轉口貿易 (Re-export)." },
  { id: 26, qZh: "香港最大的貿易夥伴是？", qEn: "Largest trading partner?", options: [{t:"中國內地 (Mainland China)",c:true}, {t:"美國 (USA)",c:false}, {t:"英國 (UK)",c:false}], expl: "內地是最大夥伴 (Mainland is #1)." },
  { id: 27, qZh: "香港就業人數最多的行業是？", qEn: "Most employed industry?", options: [{t:"貿易及物流 (Trade/Logistics)",c:true}, {t:"金融 (Finance)",c:false}, {t:"旅遊 (Tourism)",c:false}], expl: "貿易及物流聘請最多人 (Most jobs)." },
  { id: 28, qZh: "旅遊業興旺會直接帶動？", qEn: "Tourism boosts?", options: [{t:"零售/飲食/酒店 (Retail/Food/Hotel)",c:true}, {t:"採礦/農業 (Mining/Agri)",c:false}, {t:"工業/漁業 (Industry/Fish)",c:false}], expl: "遊客消費帶動 (Tourist spending)." },
  { id: 29, qZh: "哪項 **不是** 金融服務？", qEn: "NOT financial service?", options: [{t:"超級市場 (Supermarket)",c:true}, {t:"股票買賣 (Stocks)",c:false}, {t:"外匯買賣 (Forex)",c:false}], expl: "超市是零售 (Supermarket is Retail)." },
  { id: 30, qZh: "港珠澳大橋促進了哪兩個行業？", qEn: "HZMB boosts?", options: [{t:"旅遊及物流 (Tourism/Logistics)",c:true}, {t:"農業及漁業 (Agri/Fishing)",c:false}, {t:"教育及醫療 (Edu/Medical)",c:false}], expl: "方便人流物流 (Flow of people/goods)." }
];

export default function HKEconomyDefenseFixed() {
  // State
  const [gameState, setGameState] = useState<GameState>('menu');
  const [wave, setWave] = useState(1);
  const [money, setMoney] = useState(250); 
  const [lives, setLives] = useState(15); 
  const [draggedType, setDraggedType] = useState<TowerType | null>(null);
  const [selectedTowerId, setSelectedTowerId] = useState<number | null>(null);
  const [currentQ, setCurrentQ] = useState(FULL_QUESTION_BANK[0]); 
  const [feedback, setFeedback] = useState<string | null>(null);
  const [isMuted, setIsMuted] = useState(false);
  const [, setTick] = useState(0);

  // Question Deck Logic (Prevents repeats)
  const questionDeckRef = useRef<number[]>([]);

  // Refs
  const enemiesRef = useRef<Enemy[]>([]);
  const towersRef = useRef<Tower[]>([]);
  const projectilesRef = useRef<Projectile[]>([]);
  const particlesRef = useRef<Particle[]>([]);
  
  const lastTimeRef = useRef<number>(0);
  const waveActiveRef = useRef(false);
  const enemiesSpawnedRef = useRef(0);
  const lastSpawnTimeRef = useRef(0);
  const requestRef = useRef<number>(0);
  const boardRef = useRef<HTMLDivElement>(null);

  const TOWER_COST = { logistics: 100, finance: 200, tech: 300 };

  // --- Helpers ---
  const isPath = (x: number, y: number) => ALL_PATHS.some(path => path.some(p => p.x === x && p.y === y));
  const isTower = (x: number, y: number) => towersRef.current.some(t => t.x === x && t.y === y);
  
  const isValidBuild = (x: number, y: number) => {
    if (x < 0 || x >= GRID_W || y < 0 || y >= GRID_H) return false;
    if (isPath(x, y) || isTower(x, y)) return false;
    if (x >= 18 && y >= 4 && y <= 6) return false; // Base
    return true;
  };

  const getEnemyPos = (e: Enemy) => {
    const path = ALL_PATHS[e.pathId];
    const curr = path[e.pathIndex];
    const next = path[e.pathIndex + 1] || curr;
    return {
      x: curr.x + (next.x - curr.x) * e.progress,
      y: curr.y + (next.y - curr.y) * e.progress
    };
  };

  // --- Smart Question System ---
  const pickNewQuestion = () => {
    if (questionDeckRef.current.length === 0) {
      // Refill deck if empty
      questionDeckRef.current = FULL_QUESTION_BANK.map((_, i) => i);
    }
    // Random pick from deck
    const randIndex = Math.floor(Math.random() * questionDeckRef.current.length);
    const qIndex = questionDeckRef.current[randIndex];
    // Remove picked from deck
    questionDeckRef.current.splice(randIndex, 1);
    
    setCurrentQ(FULL_QUESTION_BANK[qIndex]);
  };

  const toggleMute = () => {
    const muted = AudioEngine.toggleMute();
    setIsMuted(muted);
  };

  // --- Main Game Loop ---
  const animate = useCallback((time: number) => {
    if (lastTimeRef.current === 0) lastTimeRef.current = time;
    const deltaTime = time - lastTimeRef.current;
    lastTimeRef.current = time;
    const dtFactor = deltaTime / 16.67;

    if (waveActiveRef.current) {
      const totalEnemies = 8 + (wave * 3); 
      const spawnInterval = Math.max(400, 1600 - (wave * 100)); 

      if (enemiesSpawnedRef.current < totalEnemies) {
        if (time - lastSpawnTimeRef.current > spawnInterval) {
          // Path Logic
          let pathId = 0;
          if (wave >= 2 && Math.random() > 0.6) pathId = 1; // Open paths earlier
          if (wave >= 3 && Math.random() > 0.7) pathId = 2;

          let type: EnemyType = 'ghost';
          let baseHp = 50 * Math.pow(1.18, wave); 
          let baseSpeed = 0.0055 * Math.pow(1.05, wave); 
          
          const rand = Math.random();

          // --- FIXED LOGIC: CHECK RARES FIRST! ---
          // Wave 8+: Boss
          if (wave >= 8 && rand > 0.97) {
            type = 'boss'; baseSpeed *= 0.4; baseHp *= 12; 
          }
          // Wave 6+: Flame
          else if (wave >= 6 && rand > 0.9) {
            type = 'flame'; baseSpeed *= 2.0; baseHp *= 0.8;
          }
          // Wave 4+: Robot (NEW!)
          else if (wave >= 4 && rand > 0.8) {
            type = 'robot'; baseSpeed *= 0.5; baseHp *= 3.0;
          }
          // Wave 2+: Bat (NEW!)
          else if (wave >= 2 && rand > 0.85) { 
            type = 'bat'; baseSpeed *= 1.8; baseHp *= 0.5;
          }
          // Wave 3+: Skull
          else if (wave >= 3 && rand > 0.75) { 
            type = 'skull'; baseSpeed *= 0.7; baseHp *= 2.0; 
          }
          // Wave 2+: Bug
          else if (wave >= 2 && rand > 0.6) { 
            type = 'bug'; baseSpeed *= 1.4; baseHp *= 0.7; 
          }

          enemiesRef.current.push({
            id: Math.random(),
            pathId, pathIndex: 0, progress: 0,
            hp: baseHp, maxHp: baseHp, speed: baseSpeed, type,
            visualOffset: 0
          });
          enemiesSpawnedRef.current++;
          lastSpawnTimeRef.current = time;
        }
      } else if (enemiesRef.current.length === 0) {
        waveActiveRef.current = false;
        if (wave < 12) setGameState('quiz');
        else setGameState('victory');
        AudioEngine.playWin();
      }
    }

    // Update Enemies
    enemiesRef.current.forEach(e => {
      if (e.frozen && e.frozen > time) return; 

      e.progress += e.speed * dtFactor;
      e.visualOffset = e.type === 'bat' 
        ? Math.sin(time / 50) * 8  
        : Math.sin(time / 100) * 3;

      if (e.progress >= 1) {
        e.pathIndex++;
        e.progress = 0;
        const path = ALL_PATHS[e.pathId];
        if (e.pathIndex >= path.length - 1) {
          e.hp = -1; 
          setLives(l => {
            if (l - 1 <= 0) setGameState('gameover');
            return l - 1;
          });
        }
      }
    });

    // Towers Fire
    towersRef.current.forEach(t => {
      if (time - t.lastFired > t.cooldown) {
        const target = enemiesRef.current.find(e => {
          if (e.hp <= 0) return false;
          const pos = getEnemyPos(e);
          const dist = Math.sqrt(Math.pow(pos.x - t.x, 2) + Math.pow(pos.y - t.y, 2));
          return dist <= t.range;
        });

        if (target) {
          if (t.type === 'tech') {
            particlesRef.current.push({ id: Math.random(), x: t.x+0.5, y: t.y+0.5, life: 10, color: 'cyan' }); 
            const tPos = getEnemyPos(target);
            target.hp -= t.damage;
            const freezeTime = (target.type === 'boss' || target.type === 'robot') ? 100 : 200;
            target.frozen = time + freezeTime; 
            projectilesRef.current.push({
               id: Math.random(), x: tPos.x+0.5, y: tPos.y+0.5, startX: t.x+0.5, startY: t.y+0.5,
               targetId: target.id, speed: 0, damage: 0, type: 'laser'
            });
            AudioEngine.playShoot();
          } else {
            projectilesRef.current.push({
              id: Math.random(),
              x: t.x + 0.5, y: t.y + 0.5,
              targetId: target.id,
              speed: 0.35, 
              damage: t.damage,
              type: t.type === 'logistics' ? 'box' : 'coin'
            });
            AudioEngine.playShoot();
          }
          t.lastFired = time;
        }
      }
    });

    // Update Projectiles
    projectilesRef.current = projectilesRef.current.filter(p => {
      if (p.type === 'laser') return false; 

      const target = enemiesRef.current.find(e => e.id === p.targetId);
      if (!target || target.hp <= 0) return false;

      const pos = getEnemyPos(target);
      const tx = pos.x + 0.5;
      const ty = pos.y + 0.5;
      const dx = tx - p.x;
      const dy = ty - p.y;
      const dist = Math.sqrt(dx*dx + dy*dy);
      const moveDist = p.speed * dtFactor;

      if (dist < moveDist) {
        target.hp -= p.damage;
        particlesRef.current.push({
            id: Math.random(),
            x: tx, y: ty,
            life: 20,
            color: p.type === 'box' ? 'orange' : 'yellow'
        });
        AudioEngine.playHit();
        return false; 
      } else {
        p.x += (dx / dist) * moveDist;
        p.y += (dy / dist) * moveDist;
        return true; 
      }
    });

    particlesRef.current.forEach(p => p.life -= 1 * dtFactor);
    particlesRef.current = particlesRef.current.filter(p => p.life > 0);
    enemiesRef.current = enemiesRef.current.filter(e => e.hp > 0);

    setTick(prev => prev + 1);

    if (gameState === 'playing') {
      requestRef.current = requestAnimationFrame(animate);
    }
  }, [gameState, wave]);

  useEffect(() => {
    AudioEngine.init();
    if (gameState === 'playing') {
      requestRef.current = requestAnimationFrame(animate);
    }
    return () => cancelAnimationFrame(requestRef.current);
  }, [gameState, animate]);


  // --- Interactions ---
  const handleDragStart = (type: TowerType) => { if (money >= TOWER_COST[type]) { setDraggedType(type); setSelectedTowerId(null); }};
  const handleDrop = (e: React.MouseEvent) => {
    if (!draggedType || !boardRef.current) return;
    const rect = boardRef.current.getBoundingClientRect();
    const x = Math.floor((e.clientX - rect.left) / (rect.width / GRID_W));
    const y = Math.floor((e.clientY - rect.top) / (rect.height / GRID_H));
    if (isValidBuild(x, y)) {
      setMoney(m => m - TOWER_COST[draggedType]);
      let stats = { damage: 18, range: 3.5, cooldown: 550 }; 
      if (draggedType === 'finance') stats = { damage: 75, range: 4.5, cooldown: 1300 }; 
      if (draggedType === 'tech') stats = { damage: 4, range: 4, cooldown: 150 }; 
      towersRef.current.push({ id: Math.random(), x, y, type: draggedType, level: 1, lastFired: 0, ...stats });
      AudioEngine.playBuild();
    }
    setDraggedType(null);
  };
  const upgradeTower = () => {
     const t = towersRef.current.find(t => t.id === selectedTowerId);
     if (t && money >= 150) { 
       setMoney(m => m - 150); t.level++; t.damage *= 1.3; setSelectedTowerId(null); 
       AudioEngine.playBuild();
     }
  };
  const sellTower = () => {
     const t = towersRef.current.find(t => t.id === selectedTowerId);
     if (t) { setMoney(m => m + Math.floor(TOWER_COST[t.type]*0.5)); towersRef.current = towersRef.current.filter(tx => tx.id !== selectedTowerId); setSelectedTowerId(null); }
  };
  const handleQuiz = (c: boolean) => {
      if(c) { 
          setFeedback("撥款成功！+$200"); 
          setTimeout(() => { setMoney(m=>m+200); setWave(w=>w+1); pickNewQuestion(); setGameState('playing'); enemiesSpawnedRef.current=0; waveActiveRef.current=true; setFeedback(null); }, 1000); 
      } else { 
          setFeedback("申請被拒... +$50"); 
          setTimeout(() => { setMoney(m=>m+50); setWave(w=>w+1); pickNewQuestion(); setGameState('playing'); enemiesSpawnedRef.current=0; waveActiveRef.current=true; setFeedback(null); }, 1000); 
      }
  };
  const startGame = () => {
      questionDeckRef.current = FULL_QUESTION_BANK.map((_, i) => i); // Init Deck
      pickNewQuestion();
      setGameState('quiz');
      setWave(1);
      setMoney(250); 
      setLives(15); 
      enemiesRef.current = [];
      towersRef.current = [];
      projectilesRef.current = [];
      AudioEngine.init();
  };

  // --- Render ---
  return (
    <div className="min-h-screen bg-slate-900 flex flex-col items-center justify-center p-2 select-none" onMouseUp={() => setDraggedType(null)}>
      
      {/* HUD */}
      <div className="w-full max-w-5xl bg-slate-800 p-3 rounded-xl mb-2 flex justify-between items-center border border-slate-700 text-white shadow-lg">
        <div className="flex gap-4 items-center">
            <div className="flex items-center gap-1 text-red-400 font-bold text-lg"><Heart fill="currentColor"/> {lives}</div>
            <div className="flex items-center gap-1 text-yellow-400 font-bold text-lg"><Coins fill="currentColor"/> {money}</div>
            <div className="flex items-center gap-1 text-blue-400 font-bold text-lg"><Shield/> Wave {wave}</div>
        </div>
        <div className="flex items-center gap-4">
            <div className="text-sm text-slate-400 font-bold uppercase tracking-widest flex items-center gap-2">
                HK Economy Defense <span className="text-xs text-indigo-400 bg-indigo-900/30 px-2 py-0.5 rounded font-black border border-indigo-800">FIXED</span>
            </div>
            <button onClick={toggleMute} className="text-slate-400 hover:text-white transition">
                {isMuted ? <VolumeX size={24}/> : <Volume2 size={24}/>}
            </button>
        </div>
      </div>

      {/* GAME BOARD */}
      <div 
        ref={boardRef}
        onMouseUp={handleDrop}
        className="relative w-full max-w-5xl aspect-[20/12] bg-slate-800 rounded-lg overflow-hidden shadow-2xl border-2 border-slate-700 cursor-crosshair"
        style={{
             backgroundImage: `linear-gradient(to right, rgba(255,255,255,0.03) 1px, transparent 1px), linear-gradient(to bottom, rgba(255,255,255,0.03) 1px, transparent 1px)`,
             backgroundSize: `${100/GRID_W}% ${100/GRID_H}%`
        }}
      >
        {/* Paths (Vibrant) */}
        <svg className="absolute inset-0 w-full h-full pointer-events-none opacity-40">
           {ALL_PATHS.map((path, i) => (
               <polyline key={i} points={path.map(p => `${(p.x+0.5)*(100/GRID_W)}%,${(p.y+0.5)*(100/GRID_H)}%`).join(' ')}
                 fill="none" 
                 stroke={i===0 ? "#ef4444" : i===1 ? "#10b981" : "#8b5cf6"} 
                 strokeWidth="35" strokeLinecap="round" strokeLinejoin="round" />
           ))}
        </svg>

        {/* Path Indicators */}
        <div className="absolute left-[2%] top-[38%] bg-red-500/80 px-2 py-1 rounded text-[10px] font-bold text-white z-0">Path A</div>
        <div className="absolute left-[38%] top-[2%] bg-green-500/80 px-2 py-1 rounded text-[10px] font-bold text-white z-0">Path B</div>
        <div className="absolute left-[58%] bottom-[2%] bg-purple-500/80 px-2 py-1 rounded text-[10px] font-bold text-white z-0">Path C</div>

        {/* Base */}
        <div className="absolute right-[2%] top-[42%] w-[8%] h-[15%] flex flex-col items-center justify-center z-0">
             <div className="w-14 h-14 bg-blue-600 rounded-full border-4 border-white flex items-center justify-center shadow-[0_0_20px_blue] animate-pulse">
                <Building2 className="text-white" size={24}/>
             </div>
        </div>

        {/* Towers */}
        {towersRef.current.map(t => (
            <div key={t.id} onClick={(e) => { e.stopPropagation(); setSelectedTowerId(t.id); }}
                className={`absolute transition-transform z-10 flex items-center justify-center ${selectedTowerId===t.id?'scale-110 z-20':''}`}
                style={{ left: `${t.x*(100/GRID_W)}%`, top: `${t.y*(100/GRID_H)}%`, width: `${100/GRID_W}%`, height: `${100/GRID_H}%` }}
            >
                <div className={`w-[85%] h-[85%] rounded-lg shadow-lg flex items-center justify-center border-b-4 transition-all duration-200
                    ${t.type==='logistics'?'bg-orange-500 border-orange-700':t.type==='finance'?'bg-yellow-500 border-yellow-700':'bg-cyan-500 border-cyan-700'}
                    ${selectedTowerId===t.id ? 'ring-2 ring-white shadow-[0_0_15px_rgba(255,255,255,0.5)]' : ''}
                `}>
                    {t.type==='logistics' && <Truck size={18} className="text-white"/>}
                    {t.type==='finance' && <Coins size={18} className="text-white"/>}
                    {t.type==='tech' && <Zap size={18} className="text-white"/>}
                </div>
                {t.level > 1 && <div className="absolute -top-1 -right-1 bg-black text-[10px] text-white px-1.5 rounded-full border border-gray-600">Lv{t.level}</div>}
            </div>
        ))}

        {/* Enemies (Enhanced Visuals) */}
        {enemiesRef.current.map(e => {
            const pos = getEnemyPos(e);
            return (
                <div key={e.id} className="absolute w-8 h-8 transform -translate-x-1/2 -translate-y-1/2 z-20 flex flex-col items-center justify-center transition-none will-change-transform"
                    style={{ 
                        left: `${(pos.x+0.5)*(100/GRID_W)}%`, 
                        top: `${(pos.y+0.5)*(100/GRID_H)}%`,
                        marginTop: `${e.visualOffset}px`,
                        transform: `translate(-50%, -50%) scale(${e.type === 'boss' ? 1.5 : e.type === 'bat' ? 1.3 : 1})`
                    }}
                >
                    <div className="w-full h-1 bg-gray-700 rounded mb-0.5 overflow-hidden border border-black/50">
                        <div className="h-full bg-red-500" style={{width: `${Math.max(0, (e.hp/e.maxHp)*100)}%`}}></div>
                    </div>
                    {e.type==='ghost' && <Ghost className="text-white drop-shadow-md" size={26} />}
                    {e.type==='skull' && <Skull className="text-purple-400 drop-shadow-md" size={30} />}
                    {e.type==='bug' && <Bug className="text-green-400 drop-shadow-md" size={22} />}
                    {e.type==='flame' && <Flame className="text-orange-500 fill-orange-500 drop-shadow-md animate-pulse" size={28} />}
                    {e.type==='boss' && <Gem className="text-pink-500 fill-pink-600 drop-shadow-xl" size={36} />}
                    {e.type==='bat' && <CloudLightning className="text-yellow-300 drop-shadow-md" size={32} />} 
                    {e.type==='robot' && <Bot className="text-blue-300 fill-slate-700 drop-shadow-md" size={32} />}
                    
                    {e.frozen && e.frozen > Date.now() && <div className="absolute inset-0 text-cyan-300 animate-pulse"><Zap size={24}/></div>}
                </div>
            )
        })}

        {/* Projectiles */}
        {projectilesRef.current.map(p => {
          if (p.type === 'laser') {
             return (
               <svg key={p.id} className="absolute inset-0 w-full h-full pointer-events-none z-30">
                 <line x1={`${p.startX!*(100/GRID_W)}%`} y1={`${p.startY!*(100/GRID_H)}%`} 
                       x2={`${p.x*(100/GRID_W)}%`} y2={`${p.y*(100/GRID_H)}%`} 
                       stroke="cyan" strokeWidth="3" strokeOpacity="0.8" />
               </svg>
             )
          }
          return (
            <div key={p.id} className="absolute w-3 h-3 bg-white rounded-full shadow-[0_0_8px_white] z-10 transition-none"
                style={{ left: `${p.x*(100/GRID_W)}%`, top: `${p.y*(100/GRID_H)}%`, transform: 'translate(-50%, -50%)' }}
            />
          )
        })}

        {/* Particles */}
        {particlesRef.current.map(p => (
            <div key={p.id} className="absolute w-6 h-6 rounded-full z-20 opacity-75"
                style={{ 
                    left: `${p.x*(100/GRID_W)}%`, top: `${p.y*(100/GRID_H)}%`, 
                    transform: `translate(-50%, -50%) scale(${p.life/10})`,
                    backgroundColor: p.color
                }}
            />
        ))}

        {/* Overlays */}
        {draggedType && <div className="absolute inset-0 z-50 bg-black/10 flex items-center justify-center pointer-events-none"><div className="bg-black/60 text-white px-4 py-2 rounded text-xl font-bold">拖曳放置 (Drag & Drop)</div></div>}
        
        {(gameState==='menu'||gameState==='gameover'||gameState==='victory') && (
             <div className="absolute inset-0 bg-slate-900/90 z-50 flex flex-col items-center justify-center text-white">
                 <h1 className="text-5xl font-black mb-4 bg-gradient-to-r from-blue-400 to-indigo-500 bg-clip-text text-transparent">
                    {gameState==='menu'&&"香港經濟保衛戰：修正版"}
                    {gameState==='victory'&&"完美防守！"}
                    {gameState==='gameover'&&"經濟崩潰..."}
                 </h1>
                 <p className="text-slate-400 mb-8 max-w-md text-center">
                    {gameState==='menu'&&"修復了怪物生成問題，並新增雙語對照題目！"}
                 </p>
                 <button onClick={startGame} className="bg-indigo-600 px-10 py-4 rounded-full font-bold text-xl hover:bg-indigo-500 hover:scale-105 transition flex items-center gap-3 shadow-xl border-2 border-indigo-400">
                    <Play fill="currentColor"/> {gameState==='menu'?"開始挑戰 (Start)":"再玩一次 (Retry)"}
                 </button>
             </div>
        )}
        
        {gameState==='quiz' && (
            <div className="absolute inset-0 bg-slate-900/95 z-50 flex items-center justify-center p-4">
                <div className="bg-slate-800 p-8 rounded-2xl border border-slate-600 max-w-lg w-full text-center text-white shadow-2xl">
                    <h2 className="text-2xl font-bold mb-6 text-yellow-400 border-b border-slate-600 pb-2">申請撥款 (Funding Round)</h2>
                    {!feedback ? (
                        <>
                            <p className="text-xl font-medium mb-6 leading-relaxed">{currentQ.qZh}<br/><span className="text-sm text-slate-400">{currentQ.qEn}</span></p>
                            <div className="grid gap-3">
                                {currentQ.options.map((opt,i)=>(<button key={i} onClick={()=>handleQuiz(opt.c)} className="bg-slate-700 p-4 rounded-xl hover:bg-blue-600 text-left text-lg font-bold transition-colors">{opt.t}</button>))}
                            </div>
                        </>
                    ) : (
                        <div className="text-3xl font-bold animate-bounce text-green-400">{feedback}</div>
                    )}
                </div>
            </div>
        )}
      </div>

      {/* Build Menu */}
      <div className="w-full max-w-5xl mt-4 grid grid-cols-[1fr_auto] gap-4 h-28">
         <div className="bg-slate-800 rounded-xl border border-slate-700 p-3 flex items-center gap-4 px-6 overflow-x-auto shadow-lg">
             <div className="text-slate-500 text-xs font-bold w-16 text-center leading-tight flex flex-col items-center"><Hand size={24} className="mb-1 animate-bounce"/>拖曳建造<br/>Drag</div>
             <div onMouseDown={()=>handleDragStart('logistics')} className={`relative cursor-grab active:cursor-grabbing p-2 rounded-xl bg-orange-900/30 border-2 border-orange-500/50 hover:bg-orange-900/50 w-28 flex flex-col items-center transition ${money<100?'opacity-50 grayscale':''}`}>
                 <Truck className="text-orange-400 mb-1" size={24}/><span className="text-sm font-bold text-orange-200">物流中心</span><span className="text-xs text-yellow-400">$100</span>
             </div>
             <div onMouseDown={()=>handleDragStart('finance')} className={`relative cursor-grab active:cursor-grabbing p-2 rounded-xl bg-yellow-900/30 border-2 border-yellow-500/50 hover:bg-yellow-900/50 w-28 flex flex-col items-center transition ${money<200?'opacity-50 grayscale':''}`}>
                 <Coins className="text-yellow-400 mb-1" size={24}/><span className="text-sm font-bold text-yellow-200">金融大廈</span><span className="text-xs text-yellow-400">$200</span>
             </div>
             <div onMouseDown={()=>handleDragStart('tech')} className={`relative cursor-grab active:cursor-grabbing p-2 rounded-xl bg-cyan-900/30 border-2 border-cyan-500/50 hover:bg-cyan-900/50 w-28 flex flex-col items-center transition ${money<300?'opacity-50 grayscale':''}`}>
                 <Zap className="text-cyan-400 mb-1" size={24}/><span className="text-sm font-bold text-cyan-200">創科中心</span><span className="text-xs text-yellow-400">$300</span>
             </div>
         </div>
         <div className="bg-slate-800 rounded-xl border border-slate-700 p-2 w-64 flex items-center justify-center shadow-lg">
             {selectedTowerId ? (
                 <div className="flex gap-2 w-full">
                     <button onClick={upgradeTower} disabled={money<150} className={`flex-1 bg-green-600 rounded-lg flex flex-col items-center justify-center p-2 hover:bg-green-500 transition ${money<150?'opacity-50':''}`}><ArrowUpCircle size={24}/><span className="text-sm font-bold mt-1">升級 $150</span></button>
                     <button onClick={sellTower} className="flex-1 bg-red-600 rounded-lg flex flex-col items-center justify-center p-2 hover:bg-red-500 transition"><XCircle size={24}/><span className="text-sm font-bold mt-1">拆除</span></button>
                 </div>
             ) : <div className="text-slate-500 text-sm italic text-center">點擊建築可升級或拆除<br/>Click tower to upgrade</div>}
         </div>
      </div>
    </div>
  );
}