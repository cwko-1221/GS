<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>香港經濟發展保衛戰 - v999 Final Template</title>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        @keyframes pulse-fast { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .animate-pulse-fast { animation: pulse-fast 1s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        
        /* 路線動畫 */
        @keyframes dash {
            to { stroke-dashoffset: -1; }
        }
        .path-line {
            /* 移除了 vector-effect，確保線條有正確的粗度 */
            animation: dash 1s linear infinite;
        }

        /* 核心設定：百分比流動佈局 (手機完美適配) */
        html, body {
            margin: 0; padding: 0;
            width: 100%; height: 100%;
            overflow: hidden;
            background-color: #0f172a;
            color: white;
            font-family: system-ui, -apple-system, sans-serif;
            touch-action: none;
            user-select: none;
            -webkit-user-select: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
        }
        #root { width: 100%; height: 100%; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;

        // --- ICONS (Science Theme) ---
        const IconBase = ({ children, size = "100%", className = "", ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>{children}</svg>
        );
        const Heart = (p) => <IconBase {...p}><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></IconBase>;
        const Shield = (p) => <IconBase {...p}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></IconBase>;
        const Play = (p) => <IconBase {...p}><polygon points="5 3 19 12 5 21 5 3"/></IconBase>;
        const Volume2 = (p) => <IconBase {...p}><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"/></IconBase>;
        const VolumeX = (p) => <IconBase {...p}><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><line x1="23" y1="9" x2="17" y2="15"/><line x1="17" y1="9" x2="23" y2="15"/></IconBase>;
        const Eye = (p) => <IconBase {...p}><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></IconBase>;
        const Lightbulb = (p) => <IconBase {...p}><path d="M15 14c.2-1 .7-1.7 1.5-2.5 1-1 1.5-2.2 1.5-3.5A6 6 0 0 0 6 8c0 1 .2 2.2 1.5 3.5.7.7 1.3 1.5 1.5 2.5"/><path d="M9 18h6"/><path d="M10 22h4"/></IconBase>;
        const Flask = (p) => <IconBase {...p}><path d="M10 2v7.31"/><path d="M14 2v7.31"/><path d="M8.5 2h7"/><path d="M14 9.3a6.5 6.5 0 1 1-4 0"/><path d="M5.52 16h12.96"/></IconBase>;
        const Atom = (p) => <IconBase {...p}><circle cx="12" cy="12" r="1"/><path d="M20.2 20.2c2.04-2.03.02-7.36-4.5-11.9-4.54-4.52-9.87-6.54-11.9-4.5-2.04 2.03-.02 7.36 4.5 11.9 4.54 4.52 9.87 6.54 11.9 4.5Z"/><path d="M15.7 15.7c4.52-4.54 6.54-9.87 4.5-11.9-2.03-2.04-7.36-.02-11.9 4.5-4.52 4.54-6.54 9.87-4.5 11.9 2.03 2.04 7.36.02 11.9-4.5Z"/></IconBase>;
        const Hand = (p) => <IconBase {...p}><path d="M18 11V6a2 2 0 0 0-2-2v0a2 2 0 0 0-2 2v0"/><path d="M14 10V4a2 2 0 0 0-2-2v0a2 2 0 0 0-2 2v2"/><path d="M10 10.5V6a2 2 0 0 0-2-2v0a2 2 0 0 0-2 2v8"/><path d="M18 8a2 2 0 1 1 4 0v6a8 8 0 0 1-8 8h-2c-2.8 0-4.5-.86-5.99-2.34l-3.6-3.6a2 2 0 0 1 2.83-2.82L7 15"/></IconBase>;
        const Beaker = (p) => <IconBase {...p}><path d="M4.5 3h15"/><path d="M6 3v16a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V3"/><path d="M6 14h12"/></IconBase>;
        const XCircle = (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></IconBase>;
        const ArrowUpCircle = (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"/><path d="m16 12-4-4-4 4"/><path d="M12 16V8"/></IconBase>;
        
        // Enemy Icons
        const Ghost = (p) => <IconBase {...p}><path d="M9 22v-2a2 2 0 0 1 4 0v2"/><path d="M9 22v-2a2 2 0 0 1 4 0v2"/><path d="M9 22v-2a2 2 0 0 1 4 0v2"/><path d="M18.5 12A6.5 6.5 0 0 0 5.5 12c0 2 .5 3.5 2.5 4.5v3c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2v-3c2-1 2.5-2.5 2.5-4.5Z"/><circle cx="10" cy="10" r="1"/><circle cx="14" cy="10" r="1"/></IconBase>;
        const Skull = (p) => <IconBase {...p}><circle cx="9" cy="12" r="1"/><circle cx="15" cy="12" r="1"/><path d="M8 20v2h8v-2"/><path d="m12.5 17-.5-1-.5 1h1z"/><path d="M16 20a2 2 0 0 0 1.56-3.25 8 8 0 1 0-11.12 0A2 2 0 0 0 8 20"/></IconBase>;
        const Bug = (p) => <IconBase {...p}><rect width="8" height="12" x="8" y="6" rx="4"/><path d="m19 7-3 3"/><path d="m5 7 3 3"/><path d="m19 19-3-3"/><path d="m5 19 3-3"/><path d="M20 13h-4"/><path d="M4 13h4"/><path d="m10 4 1 2"/><path d="m14 4-1 2"/></IconBase>;
        const Flame = (p) => <IconBase {...p}><path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.1.2-2.2.6-3.3.7-1.9 3.8-3.3 2.9-6.2Z"/></IconBase>;
        const Gem = (p) => <IconBase {...p}><path d="M6 3h12l4 6-10 13L2 9Z"/><path d="M11 3 8 9l4 13 4-13-3-6"/><path d="M2 9h20"/></IconBase>;
        const Bot = (p) => <IconBase {...p}><path d="M12 8V4H8"/><rect width="16" height="12" x="4" y="8" rx="2"/><path d="M2 14h2"/><path d="M20 14h2"/><path d="M15 13v2"/><path d="M9 13v2"/></IconBase>;
        const CloudLightning = (p) => <IconBase {...p}><path d="M6 16.326A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 .5 8.973"/><path d="m13 12-3 5h4l-3 5"/></IconBase>;

        // --- CONSTANTS ---
        const GRID_W = 20;
        const GRID_H = 12;
        const TOWER_COST = { observe: 100, hypothesis: 200, experiment: 300 };
        // Path coordinates (Grid: 0-19, 0-11)
        const PATH_LEFT=[{x:0,y:5},{x:1,y:5},{x:2,y:5},{x:3,y:5},{x:4,y:5},{x:5,y:5},{x:5,y:4},{x:5,y:3},{x:6,y:3},{x:7,y:3},{x:8,y:3},{x:9,y:3},{x:10,y:3},{x:10,y:4},{x:10,y:5},{x:11,y:5},{x:12,y:5},{x:13,y:5},{x:14,y:5},{x:15,y:5},{x:16,y:5},{x:17,y:5},{x:18,y:5},{x:19,y:5}];
        const PATH_TOP=[{x:8,y:0},{x:8,y:1},{x:8,y:2},{x:8,y:3},{x:9,y:3},{x:10,y:3},{x:10,y:4},{x:10,y:5},{x:11,y:5},{x:12,y:5},{x:13,y:5},{x:14,y:5},{x:15,y:5},{x:16,y:5},{x:17,y:5},{x:18,y:5},{x:19,y:5}];
        const PATH_BOTTOM=[{x:12,y:11},{x:12,y:10},{x:12,y:9},{x:12,y:8},{x:12,y:7},{x:12,y:6},{x:12,y:5},{x:13,y:5},{x:14,y:5},{x:15,y:5},{x:16,y:5},{x:17,y:5},{x:18,y:5},{x:19,y:5}];
        const ALL_PATHS = [PATH_LEFT, PATH_TOP, PATH_BOTTOM];

        const AudioEngine = {
          ctx: null, isMuted: false,
          init: () => { if (!AudioEngine.ctx) AudioEngine.ctx = new (window.AudioContext || window.webkitAudioContext)(); },
          playTone: (freq, type, duration, vol = 0.1) => {
            if (AudioEngine.isMuted || !AudioEngine.ctx) return;
            const osc = AudioEngine.ctx.createOscillator(); const gain = AudioEngine.ctx.createGain();
            osc.type = type; osc.frequency.setValueAtTime(freq, AudioEngine.ctx.currentTime);
            gain.gain.setValueAtTime(vol, AudioEngine.ctx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, AudioEngine.ctx.currentTime + duration);
            osc.connect(gain); gain.connect(AudioEngine.ctx.destination);
            osc.start(); osc.stop(AudioEngine.ctx.currentTime + duration);
          },
          playShoot: () => AudioEngine.playTone(400, 'square', 0.1, 0.05),
          playHit: () => AudioEngine.playTone(100, 'sawtooth', 0.1, 0.05),
          playBuild: () => AudioEngine.playTone(600, 'sine', 0.2, 0.1),
          playWin: () => { [523.25, 659.25, 783.99, 1046.50].forEach((f, i) => setTimeout(() => AudioEngine.playTone(f, 'square', 0.3, 0.1), i * 100)); },
          toggleMute: () => { AudioEngine.isMuted = !AudioEngine.isMuted; return AudioEngine.isMuted; }
        };

        // --- NEW ECONOMY & INDUSTRY QUESTION BANK (24 Questions) ---
        const FULL_QUESTION_BANK = [
          { id: 1, qZh: "1. 香港的四大主要行業類別是經濟增長的主要動力。以下哪一項 不屬於 這四大行業？", qEn: "Which of the following is NOT one of Hong Kong's four main industries?", options: [{t:"A. 金融服務業 (Financial Services)",c:false}, {t:"B. 農業及重工業 (Agriculture & Heavy Ind.)",c:true}, {t:"C. 旅遊業 (Tourism)",c:false}, {t:"D. 貿易及物流業 (Trading & Logistics)",c:false}], expl: "農業及重工業不是香港四大支柱產業。" },
          { id: 2, qZh: "2. 香港缺乏天然資源，大部份食品、原料和日用品都需要依靠甚麼方式來滿足生活所需？", qEn: "HK lacks natural resources, relies on what for daily needs?", options: [{t:"A. 自給自足 (Self-sufficiency)",c:false}, {t:"B. 進口 (Import)",c:true}, {t:"C. 轉口 (Re-export)",c:false}, {t:"D. 出口 (Export)",c:false}], expl: "香港依賴進口來獲取大部分資源。" },
          { id: 3, qZh: "3. 根據資料，目前香港最大的貿易夥伴是哪一個國家或地區？", qEn: "Who is HK's largest trading partner?", options: [{t:"A. 美國 (USA)",c:false}, {t:"B. 日本 (Japan)",c:false}, {t:"C. 中國內地 (The Mainland of China)",c:true}, {t:"D. 新加坡 (Singapore)",c:false}], expl: "中國內地是香港最大的貿易夥伴。" },
          { id: 4, qZh: "4. 「把貨品出口和轉口」為香港帶來收益。甚麼是「轉口貿易」？", qEn: "What is 'Re-export trade'?", options: [{t:"A. 香港製造直接賣去外國 (HK made sold abroad)",c:false}, {t:"B. 外國貨經港運內地/內地貨經港運外國 (Transit via HK)",c:true}, {t:"C. 市民買外國貨自用 (Buy for personal use)",c:false}, {t:"D. 舊貨品回收再造 (Recycling)",c:false}], expl: "轉口是指貨品經香港轉運至其他地方。" },
          { id: 5, qZh: "5. 根據資料，為甚麼香港的「轉口貿易」收益遠高於「產品出口」？", qEn: "Why is 'Re-export' revenue higher than 'Domestic Exports'?", options: [{t:"A. 沒足夠港口 (Not enough ports)",c:false}, {t:"B. 工廠北移，本地產品減少 (Factories moved north)",c:true}, {t:"C. 港人喜歡外國貨 (Prefer foreign goods)",c:false}, {t:"D. 禁止本地工廠 (Banned local factories)",c:false}], expl: "隨著工廠北移，香港本地生產大幅減少。" },
          { id: 6, qZh: "6. 香港物流業目前面對甚麼挑戰？", qEn: "What challenges is HK's logistics industry facing?", options: [{t:"A. 只有用地不足 (Land shortage only)",c:false}, {t:"B. 只有人手短缺 (Labor shortage only)",c:false}, {t:"C. 只有競爭激烈 (Intense competition only)",c:false}, {t:"D. 以上皆是 (All of the above)",c:true}], expl: "物流業面對用地、人手及競爭等多重挑戰。" },
          { id: 7, qZh: "7. 為了應對物流業的挑戰，業界正在應用科技推動甚麼改變？", qEn: "How is tech changing logistics?", options: [{t:"A. 減少進口 (Reducing imports)",c:false}, {t:"B. 物流自動化 (Logistics automation)",c:true}, {t:"C. 增加人手 (More manual labor)",c:false}, {t:"D. 停止轉口 (Stop re-export)",c:false}], expl: "自動化有助提升效率及解決人手問題。" },
          { id: 8, qZh: "8. 以下哪一項 不屬於 物流業的運作過程？", qEn: "Which is NOT part of logistics?", options: [{t:"A. 倉務管理 (Warehouse mgmt)",c:false}, {t:"B. 包裝和貼標籤 (Packaging)",c:false}, {t:"C. 運送貨品 (Transporting)",c:false}, {t:"D. 種植農作物 (Growing crops)",c:true}], expl: "種植屬於農業，不屬於物流業。" },
          { id: 9, qZh: "9. 旅遊業的發展能夠帶動香港多個行業的增長。以下哪一個行業 最直接 受惠於旅遊業？", qEn: "Which industry benefits MOST directly from tourism?", options: [{t:"A. 建築業 (Construction)",c:false}, {t:"B. 酒店及零售業 (Hotel and Retail)",c:true}, {t:"C. 教育業 (Education)",c:false}, {t:"D. 漁農業 (Agriculture)",c:false}], expl: "遊客直接帶動酒店和零售消費。" },
          { id: 10, qZh: "10. 為了讓香港經濟邁向「多元化」，政府積極推動甚麼行業？", qEn: "Which industry is promoted for economic diversification?", options: [{t:"A. 銀行櫃員 (Bank tellers)",c:false}, {t:"B. 創新科技及科研 (Innovation & Tech)",c:true}, {t:"C. 導遊 (Tour guides)",c:false}, {t:"D. 倉務管理 (Warehouse mgmt)",c:false}], expl: "創新科技是經濟多元化的重點。" },
          { id: 11, qZh: "11. 連接香港、珠海和澳門，促進三地經濟和運輸的跨海通道是甚麼？", qEn: "Sea channel connecting HK, Zhuhai, and Macao?", options: [{t:"A. 高鐵 (High Speed Rail)",c:false}, {t:"B. 蓮塘口岸 (Liantang Point)",c:false}, {t:"C. 港珠澳大橋 (HK-Zhuhai-Macao Bridge)",c:true}, {t:"D. 深中通道 (Shenzhen-Zhongshan Link)",c:false}], expl: "港珠澳大橋連接三地。" },
          { id: 12, qZh: "12. 廣深港高速鐵路（香港段）的車站位於哪裡？", qEn: "Where is the HK High Speed Rail station?", options: [{t:"A. 中環 (Central)",c:false}, {t:"B. 羅湖 (Lo Wu)",c:false}, {t:"C. 西九龍 (West Kowloon)",c:true}, {t:"D. 赤鱲角 (Chek Lap Kok)",c:false}], expl: "高鐵總站位於西九龍。" },
          { id: 13, qZh: "13. 蓮塘/香園圍口岸是香港和深圳之間的第幾個陸路口岸？", qEn: "Liantang is the ___ land crossing to Shenzhen?", options: [{t:"A. 第五個 (5th)",c:false}, {t:"B. 第六個 (6th)",c:false}, {t:"C. 第七個 (7th)",c:true}, {t:"D. 第八個 (8th)",c:false}], expl: "它是第七個陸路口岸。" },
          { id: 14, qZh: "14. 在中港互動互利的合作關係中，香港主要為內地提供甚麼優勢？", qEn: "What advantage does HK provide to Mainland?", options: [{t:"A. 土地資源 (Land)",c:false}, {t:"B. 廉價勞動力 (Cheap labor)",c:false}, {t:"C. 科研設施 (Research facilities)",c:false}, {t:"D. 金融人才及專業服務 (Financial talent)",c:true}], expl: "香港提供專業服務及金融優勢。" },
          { id: 15, qZh: "15. 在中港合作關係中，中國內地主要為香港提供甚麼優勢？", qEn: "What advantage does Mainland provide to HK?", options: [{t:"A. 營商經驗 (Business exp)",c:false}, {t:"B. 龐大市場及生產基地 (Market & Base)",c:true}, {t:"C. 股票市場 (Stock market)",c:false}, {t:"D. 法律專才 (Legal pros)",c:false}], expl: "內地提供廣闊市場和生產基地。" },
          { id: 16, qZh: "16. 以下哪一項 不是 金融服務業的範疇？", qEn: "Which is NOT Financial Services?", options: [{t:"A. 外匯買賣 (Foreign exchange)",c:false}, {t:"B. 股票買賣 (Stocks)",c:false}, {t:"C. 貨存管理 (Inventory mgmt)",c:true}, {t:"D. 保險服務 (Insurance)",c:false}], expl: "貨存管理屬於物流業。" },
          { id: 17, qZh: "17. 根據招聘廣告，想成為「手機程式開發員」通常需要具備甚麼能力？", qEn: "Requirement for App Developer?", options: [{t:"A. 熟悉編寫程式 (Coding skills)",c:true}, {t:"B. 生物醫學學位 (Biomed degree)",c:false}, {t:"C. 駕駛貨車 (Driving truck)",c:false}, {t:"D. 導遊牌照 (Guide license)",c:false}], expl: "開發員需要編程技能。" },
          { id: 18, qZh: "18. 根據招聘廣告，申請「生物醫學研究助理」需要具備甚麼特質？", qEn: "Quality for Research Assistant?", options: [{t:"A. 體力充沛 (Strength)",c:false}, {t:"B. 駕駛執照 (Driving license)",c:false}, {t:"C. 細心和具分析力 (Analytical)",c:true}, {t:"D. 銷售技巧 (Sales skills)",c:false}], expl: "研究需要細心和分析力。" },
          { id: 19, qZh: "19. 粵港澳大灣區包括香港、澳門以及哪個省份的城市？", qEn: "Greater Bay Area includes cities from which province?", options: [{t:"A. 廣西 (Guangxi)",c:false}, {t:"B. 福建 (Fujian)",c:false}, {t:"C. 廣東 (Guangdong)",c:true}, {t:"D. 海南 (Hainan)",c:false}], expl: "包括廣東省的九個城市。" },
          { id: 20, qZh: "20. 香港與世界各地進行貿易，帶動了哪個行業的蓬勃發展？", qEn: "Global trade drives which industry?", options: [{t:"A. 教育業 (Education)",c:false}, {t:"B. 物流業 (Logistics)",c:true}, {t:"C. 醫療業 (Medical)",c:false}, {t:"D. 體育產業 (Sports)",c:false}], expl: "貿易頻繁直接帶動物流業。" },
          { id: 21, qZh: "21. 以下哪項是香港物流業面對的「內部挑戰」？", qEn: "Internal challenge for HK logistics?", options: [{t:"A. 人手短缺 (Labor shortage)",c:true}, {t:"B. 全球暖化 (Global warming)",c:false}, {t:"C. 遊客太多 (Too many tourists)",c:false}, {t:"D. 匯率下跌 (Exchange rate)",c:false}], expl: "人手短缺是內部主要挑戰。" },
          { id: 22, qZh: "22. 香港主要行業類別中，「專業及工商業支援服務」不包括下列哪項？", qEn: "NOT Professional & Producer Services?", options: [{t:"A. 會計服務 (Accounting)",c:false}, {t:"B. 法律服務 (Legal)",c:false}, {t:"C. 導遊服務 (Tour guide)",c:true}, {t:"D. 建築設計 (Architecture)",c:false}], expl: "導遊服務屬於旅遊業。" },
          { id: 23, qZh: "23. 如果沒有進口貨品，我們的生活會有甚麼影響？", qEn: "Impact of no imports?", options: [{t:"A. 生活提升 (Better life)",c:false}, {t:"B. 無法取得生活所需 (Lack necessities)",c:true}, {t:"C. 節省金錢 (Save money)",c:false}, {t:"D. 沒有影響 (No impact)",c:false}], expl: "香港依賴進口，沒有進口將無法生活。" },
          { id: 24, qZh: "24. 中國內地與香港的貿易關係非常密切，內地是香港的甚麼？", qEn: "Mainland is HK's...?", options: [{t:"A. 競爭對手 (Competitor)",c:false}, {t:"B. 最大的貿易夥伴 (Largest partner)",c:true}, {t:"C. 遊客來源 (Tourist source)",c:false}, {t:"D. 能源供應者 (Energy supplier)",c:false}], expl: "內地是香港最大的貿易夥伴。" }
        ];

        function App() {
          const [gameState, setGameState] = useState('menu');
          const [wave, setWave] = useState(1);
          const [money, setMoney] = useState(300); 
          const [lives, setLives] = useState(15); 
          const [draggedType, setDraggedType] = useState(null);
          const [dragPos, setDragPos] = useState({ x: 0, y: 0 });
          const [selectedTowerId, setSelectedTowerId] = useState(null);
          const [currentQ, setCurrentQ] = useState(FULL_QUESTION_BANK[0]); 
          const [feedback, setFeedback] = useState(null);
          const [isMuted, setIsMuted] = useState(false);
          const [hoverGrid, setHoverGrid] = useState(null);
          const [, setTick] = useState(0);
          
          const questionDeckRef = useRef([]);
          const enemiesRef = useRef([]);
          const towersRef = useRef([]);
          const projectilesRef = useRef([]);
          const particlesRef = useRef([]);
          const lastTimeRef = useRef(0);
          const waveActiveRef = useRef(false);
          const enemiesSpawnedRef = useRef(0);
          const lastSpawnTimeRef = useRef(0);
          const requestRef = useRef(0);
          const boardRef = useRef(null);

          const isValidBuild = (x, y) => { 
            if (x < 0 || x >= GRID_W || y < 0 || y >= GRID_H) return false;
            if (ALL_PATHS.some(path => path.some(p => p.x === x && p.y === y))) return false;
            if (towersRef.current.some(t => t.x === x && t.y === y)) return false;
            if (x >= 18 && y >= 4 && y <= 6) return false;
            return true; 
          };

          const getEnemyPos = (e) => { 
             const path = ALL_PATHS[e.pathId]; 
             const curr = path[e.pathIndex]; 
             const next = path[e.pathIndex + 1] || curr; 
             // Percentage Logic for V6.0 structure
             return { 
                 x: curr.x + (next.x - curr.x) * e.progress, 
                 y: curr.y + (next.y - curr.y) * e.progress 
             }; 
          };

          const pickNewQuestion = () => { if (questionDeckRef.current.length === 0) questionDeckRef.current = FULL_QUESTION_BANK.map((_, i) => i); const r = Math.floor(Math.random() * questionDeckRef.current.length); const q = questionDeckRef.current[r]; questionDeckRef.current.splice(r, 1); setCurrentQ(FULL_QUESTION_BANK[q]); };
          const toggleMute = () => { setIsMuted(AudioEngine.toggleMute()); };

          const animate = useCallback((time) => {
            if (lastTimeRef.current === 0) lastTimeRef.current = time;
            const deltaTime = time - lastTimeRef.current;
            lastTimeRef.current = time;
            const dtFactor = deltaTime / 16.67;

            if (waveActiveRef.current) {
              const totalEnemies = 8 + (wave * 3); 
              const spawnInterval = Math.max(400, 1600 - (wave * 100)); 
              if (enemiesSpawnedRef.current < totalEnemies) {
                if (time - lastSpawnTimeRef.current > spawnInterval) {
                  let pathId = 0;
                  if (wave >= 2 && Math.random() > 0.6) pathId = 1;
                  if (wave >= 3 && Math.random() > 0.7) pathId = 2;
                  let type = 'ghost'; let baseHp = 50 * Math.pow(1.18, wave); let baseSpeed = 0.0055 * Math.pow(1.05, wave); const rand = Math.random();
                  
                  if (wave >= 8 && rand > 0.97) { type = 'boss'; baseSpeed *= 0.4; baseHp *= 12; }
                  else if (wave >= 6 && rand > 0.9) { type = 'flame'; baseSpeed *= 2.0; baseHp *= 0.8; }
                  else if (wave >= 4 && rand > 0.8) { type = 'robot'; baseSpeed *= 0.5; baseHp *= 3.0; }
                  else if (wave >= 2 && rand > 0.85) { type = 'bat'; baseSpeed *= 1.8; baseHp *= 0.5; }
                  else if (wave >= 3 && rand > 0.75) { type = 'skull'; baseSpeed *= 0.7; baseHp *= 2.0; }
                  else if (wave >= 2 && rand > 0.6) { type = 'bug'; baseSpeed *= 1.4; baseHp *= 0.7; }
                  enemiesRef.current.push({ id: Math.random(), pathId, pathIndex: 0, progress: 0, hp: baseHp, maxHp: baseHp, speed: baseSpeed, type, visualOffset: 0 });
                  enemiesSpawnedRef.current++; lastSpawnTimeRef.current = time;
                }
              } else if (enemiesRef.current.length === 0) {
                waveActiveRef.current = false; if (wave < 12) setGameState('quiz'); else setGameState('victory'); AudioEngine.playWin();
              }
            }

            enemiesRef.current.forEach(e => { 
                if (e.frozen && e.frozen > time) return; 
                e.progress += e.speed * dtFactor; 
                e.visualOffset = e.type === 'bat' ? Math.sin(time / 50) * 0.5 : Math.sin(time / 100) * 0.2; 
                if (e.progress >= 1) { 
                    e.pathIndex++; e.progress = 0; 
                    const path = ALL_PATHS[e.pathId]; 
                    if (e.pathIndex >= path.length - 1) { 
                        e.hp = -1; setLives(l => { if (l - 1 <= 0) setGameState('gameover'); return l - 1; }); 
                    } 
                } 
            });

            towersRef.current.forEach(t => {
              if (time - t.lastFired > t.cooldown) {
                const target = enemiesRef.current.find(e => { 
                    if (e.hp <= 0) return false; 
                    const pos = getEnemyPos(e); 
                    const dist = Math.sqrt(Math.pow(pos.x - (t.x), 2) + Math.pow(pos.y - (t.y), 2)); 
                    return dist <= t.range; 
                });
                if (target) {
                  const tPos = getEnemyPos(target); 
                  const visY = tPos.y + (target.visualOffset || 0);

                  if (t.type === 'experiment') { 
                      target.hp -= t.damage; 
                      particlesRef.current.push({ id: Math.random(), x: t.x+0.5, y: t.y+0.5, life: 10, color: 'cyan' }); 
                      const freezeTime = (target.type === 'boss' || target.type === 'robot') ? 100 : 200; target.frozen = time + freezeTime; 
                      projectilesRef.current.push({ id: Math.random(), x: tPos.x+0.5, y: visY+0.5, startX: t.x+0.5, startY: t.y+0.5, targetId: target.id, speed: 0, damage: 0, type: 'laser', life: 5 }); 
                      AudioEngine.playShoot(); 
                  } else { 
                      projectilesRef.current.push({ id: Math.random(), x: t.x + 0.5, y: t.y + 0.5, targetId: target.id, speed: 0.7, damage: t.damage, type: t.type === 'observe' ? 'box' : 'coin' }); 
                      AudioEngine.playShoot(); 
                  }
                  t.lastFired = time;
                }
              }
            });

            projectilesRef.current = projectilesRef.current.filter(p => { 
                if (p.type === 'laser') { p.life = (p.life || 0) - 1; return p.life > 0; } 
                const target = enemiesRef.current.find(e => e.id === p.targetId); 
                if (!target || target.hp <= 0) return false; 
                
                const pos = getEnemyPos(target); 
                const visualShiftY = (target.visualOffset || 0) / 40;
                
                const tx = pos.x + 0.5; const ty = pos.y + 0.5 + visualShiftY; 
                const dx = tx - p.x; const dy = ty - p.y; 
                const dist = Math.sqrt(dx*dx + dy*dy); 
                const moveDist = p.speed * dtFactor; 
                if (dist < moveDist) { 
                    target.hp -= p.damage; 
                    particlesRef.current.push({ id: Math.random(), x: tx, y: ty, life: 20, color: p.type === 'box' ? 'orange' : 'yellow' }); 
                    AudioEngine.playHit(); 
                    return false; 
                } else { 
                    p.x += (dx / dist) * moveDist; 
                    p.y += (dy / dist) * moveDist; 
                    return true; 
                } 
            });

            particlesRef.current.forEach(p => p.life -= 1 * dtFactor); 
            particlesRef.current = particlesRef.current.filter(p => p.life > 0); 
            enemiesRef.current = enemiesRef.current.filter(e => e.hp > 0);

            setTick(prev => prev + 1); 
            if (gameState === 'playing') requestRef.current = requestAnimationFrame(animate);
          }, [gameState, wave]);

          useEffect(() => { AudioEngine.init(); if (gameState === 'playing') requestRef.current = requestAnimationFrame(animate); return () => cancelAnimationFrame(requestRef.current); }, [gameState, animate]);

          const handleDragStart = (type, e) => {
            if (e.type === 'touchstart') e.preventDefault();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            if (money >= TOWER_COST[type]) { setDraggedType(type); setDragPos({ x: clientX, y: clientY }); setSelectedTowerId(null); }
          };

          useEffect(() => {
            if (!draggedType) { setHoverGrid(null); return; }
            const handleMove = (e) => {
                if (e.type === 'touchmove') e.preventDefault();
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                setDragPos({ x: clientX, y: clientY });

                if (boardRef.current) {
                   const rect = boardRef.current.getBoundingClientRect();
                   if (clientX >= rect.left && clientX <= rect.right && clientY >= rect.top && clientY <= rect.bottom) {
                       const relX = clientX - rect.left;
                       const relY = clientY - rect.top;
                       // PERCENTAGE CALCULATION
                       const cellW = rect.width / GRID_W;
                       const cellH = rect.height / GRID_H;
                       const x = Math.floor(relX / cellW);
                       const y = Math.floor(relY / cellH);
                       setHoverGrid({x, y, valid: isValidBuild(x,y)});
                   } else {
                       setHoverGrid(null);
                   }
                }
            };
            const handleEnd = (e) => {
               const clientX = e.changedTouches ? e.changedTouches[0].clientX : e.clientX;
               const clientY = e.changedTouches ? e.changedTouches[0].clientY : e.clientY;
               if (boardRef.current) {
                   const rect = boardRef.current.getBoundingClientRect();
                   if (clientX >= rect.left && clientX <= rect.right && clientY >= rect.top && clientY <= rect.bottom) {
                       const cellW = rect.width / GRID_W;
                       const cellH = rect.height / GRID_H;
                       const x = Math.floor((clientX - rect.left) / cellW);
                       const y = Math.floor((clientY - rect.top) / cellH);
                       
                       if (isValidBuild(x, y)) {
                           AudioEngine.playBuild();
                           let stats = { damage: 18, range: 3.5, cooldown: 550 }; 
                           if (draggedType === 'hypothesis') stats = { damage: 75, range: 4.5, cooldown: 1300 }; 
                           if (draggedType === 'experiment') stats = { damage: 4, range: 4, cooldown: 150 }; 
                           towersRef.current.push({ id: Math.random(), x, y, type: draggedType, level: 1, lastFired: 0, ...stats });
                           setMoney(prev => prev - TOWER_COST[draggedType]);
                       }
                   }
               }
               setDraggedType(null);
               setHoverGrid(null);
            };
            window.addEventListener('mousemove', handleMove); window.addEventListener('touchmove', handleMove, { passive: false });
            window.addEventListener('mouseup', handleEnd); window.addEventListener('touchend', handleEnd);
            return () => { window.removeEventListener('mousemove', handleMove); window.removeEventListener('touchmove', handleMove); window.removeEventListener('mouseup', handleEnd); window.removeEventListener('touchend', handleEnd); };
          }, [draggedType]);

          const upgradeTower = () => { const t = towersRef.current.find(t => t.id === selectedTowerId); if (t && money >= 150) { setMoney(m => m - 150); t.level++; t.damage *= 1.3; setSelectedTowerId(null); AudioEngine.playBuild(); } };
          const sellTower = () => { const t = towersRef.current.find(t => t.id === selectedTowerId); if (t) { setMoney(m => m + Math.floor(TOWER_COST[t.type]*0.5)); towersRef.current = towersRef.current.filter(tx => tx.id !== selectedTowerId); setSelectedTowerId(null); } };
          const handleQuiz = (c) => { if(c) { setFeedback("經費批准！(Approved!) +$200"); setTimeout(() => { setMoney(m=>m+200); setWave(w=>w+1); pickNewQuestion(); setGameState('playing'); enemiesSpawnedRef.current=0; waveActiveRef.current=true; setFeedback(null); }, 1000); } else { setFeedback("申請被拒... (Rejected) +$50"); setTimeout(() => { setMoney(m=>m+50); setWave(w=>w+1); pickNewQuestion(); setGameState('playing'); enemiesSpawnedRef.current=0; waveActiveRef.current=true; setFeedback(null); }, 1000); } };
          const startGame = () => { questionDeckRef.current = FULL_QUESTION_BANK.map((_, i) => i); pickNewQuestion(); setGameState('quiz'); setWave(1); setMoney(300); setLives(15); enemiesRef.current = []; towersRef.current = []; projectilesRef.current = []; AudioEngine.init(); };

          return (
            <div className="flex flex-col h-full w-full bg-slate-900 select-none overflow-hidden text-white">
              
              <div className="h-12 bg-slate-800 border-b border-slate-700 flex justify-between items-center px-4 shadow-md z-10 shrink-0">
                <div className="flex gap-4 items-center text-sm md:text-base">
                    <div className="flex items-center gap-1 text-red-400 font-bold"><Heart size={18} className="fill-current"/> {lives}</div>
                    <div className="flex items-center gap-1 text-yellow-400 font-bold"><Atom size={18} className="fill-current"/> {money}</div>
                    <div className="flex items-center gap-1 text-blue-400 font-bold"><Shield size={18}/> {wave}</div>
                </div>
                <div className="flex items-center gap-2">
                    <span className="hidden md:inline text-xs text-slate-400 font-bold uppercase border px-2 py-0.5 rounded">v999 Template</span>
                    <button onClick={toggleMute} className="text-slate-400 hover:text-white p-1">
                        {isMuted ? <VolumeX size={20}/> : <Volume2 size={20}/>}
                    </button>
                </div>
              </div>

              <div className="flex-1 flex items-center justify-center bg-slate-900 overflow-hidden w-full relative p-2">
                
                <div 
                    ref={boardRef}
                    className="relative bg-slate-800 shadow-2xl border-2 border-slate-700 mx-auto"
                    style={{
                        width: '100%',
                        height: 'auto',
                        maxHeight: '100%',
                        maxWidth: '100%',
                        aspectRatio: '20/12',
                        backgroundImage: `linear-gradient(to right, rgba(255,255,255,0.03) 1px, transparent 1px), linear-gradient(to bottom, rgba(255,255,255,0.03) 1px, transparent 1px)`,
                        backgroundSize: `5% 8.333%`
                    }}
                >
                    {/* Hover Grid Highlight */}
                    {hoverGrid && (
                        <div 
                            className={`absolute z-0 border-2 ${hoverGrid.valid ? 'border-green-400 bg-green-500/30' : 'border-red-400 bg-red-500/30'}`}
                            style={{ 
                                left: `${hoverGrid.x * 5}%`, 
                                top: `${hoverGrid.y * 8.333}%`, 
                                width: '5%', height: '8.333%' 
                            }}
                        />
                    )}

                    {/* PATH VISUALIZATION - UPDATE: Increased strokeWidth to 3 as requested */}
                    <svg className="absolute inset-0 w-full h-full pointer-events-none opacity-40" viewBox="0 0 20 12" preserveAspectRatio="none">
                        {ALL_PATHS.map((path, i) => (
                            <polyline key={i} 
                                points={path.map(p => `${p.x + 0.5},${p.y + 0.5}`).join(' ')}
                                fill="none" 
                                stroke={i===0?"#ef4444":i===1?"#10b981":"#8b5cf6"} 
                                strokeWidth="0.3" 
                                strokeLinecap="round" 
                                strokeLinejoin="round" 
                                className="path-line" 
                                strokeDasharray="0.3 0.3"
                            />
                        ))}
                    </svg>

                    <div className="absolute left-2 top-[35%] bg-red-500/80 px-2 py-1 rounded text-[10px] font-bold z-0">Path A</div>
                    <div className="absolute left-[35%] top-2 bg-green-500/80 px-2 py-1 rounded text-[10px] font-bold z-0">Path B</div>
                    <div className="absolute left-[55%] bottom-2 bg-purple-500/80 px-2 py-1 rounded text-[10px] font-bold z-0">Path C</div>

                    <div className="absolute right-[2%] top-[42%] w-[8%] h-[15%] flex items-center justify-center z-0">
                        <div className="w-full h-full bg-blue-600 rounded-full border-2 border-white flex items-center justify-center shadow-[0_0_10px_blue] animate-pulse">
                            <Beaker className="text-white w-2/3 h-2/3"/>
                        </div>
                    </div>

                    {towersRef.current.map(t => (
                        <div key={t.id} onClick={(e) => { e.stopPropagation(); setSelectedTowerId(t.id); }}
                            className={`absolute z-10 flex items-center justify-center ${selectedTowerId===t.id?'scale-110 z-20':''}`}
                            style={{ left: `${t.x*5}%`, top: `${t.y*8.333}%`, width: '5%', height: '8.333%' }}
                        >
                            <div className={`w-[80%] h-[80%] rounded shadow-lg flex items-center justify-center border-b-2 transition-all duration-200
                                ${t.type==='observe'?'bg-orange-500 border-orange-700':t.type==='hypothesis'?'bg-yellow-500 border-yellow-700':'bg-cyan-500 border-cyan-700'}
                                ${selectedTowerId===t.id ? 'ring-2 ring-white' : ''}
                            `}>
                                {t.type==='observe' && <Eye size="70%" className="text-white"/>}
                                {t.type==='hypothesis' && <Lightbulb size="70%" className="text-white"/>}
                                {t.type==='experiment' && <Flask size="70%" className="text-white"/>}
                            </div>
                            {t.level > 1 && <div className="absolute -top-1 -right-1 bg-black text-[8px] px-1 rounded-full border border-gray-600">Lv{t.level}</div>}
                        </div>
                    ))}

                    {enemiesRef.current.map(e => {
                        const pos = getEnemyPos(e);
                        return (
                            <div key={e.id} className="absolute z-20 flex flex-col items-center justify-center transition-none"
                                style={{ 
                                    left: `${pos.x*5 + 2.5}%`, 
                                    top: `${pos.y*8.333 + 4.166}%`, 
                                    transform: 'translate(-50%, -50%)',
                                    marginTop: `${e.visualOffset * 40}px`,
                                    width: '5%', height: '8.333%'
                                }}
                            >
                                <div className="absolute -top-[30%] w-[80%] h-[15%] bg-gray-900 border border-gray-600 rounded-sm overflow-hidden min-h-[3px]">
                                    <div className="h-full bg-red-500 transition-all duration-100" style={{width: `${Math.max(0, (e.hp/e.maxHp)*100)}%`}}></div>
                                </div>
                                {e.type==='ghost' && <Ghost className="text-white drop-shadow-md w-full h-full" />}
                                {e.type==='skull' && <Skull className="text-purple-400 drop-shadow-md w-full h-full" />}
                                {e.type==='bug' && <Bug className="text-green-400 drop-shadow-md w-full h-full" />}
                                {e.type==='flame' && <Flame className="text-orange-500 fill-orange-500 drop-shadow-md w-full h-full" />}
                                {e.type==='boss' && <Gem className="text-pink-500 fill-pink-600 drop-shadow-xl w-[120%] h-[120%]" />}
                                {e.type==='bat' && <CloudLightning className="text-yellow-300 drop-shadow-md w-full h-full" />} 
                                {e.type==='robot' && <Bot className="text-blue-300 fill-slate-700 drop-shadow-md w-full h-full" />}
                                {e.frozen && e.frozen > Date.now() && <div className="absolute inset-0 text-cyan-300 animate-pulse"><IconBase><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></IconBase></div>}
                            </div>
                        )
                    })}

                    {projectilesRef.current.map(p => {
                        if (p.type === 'laser') {
                            return (
                            <svg key={p.id} className="absolute inset-0 w-full h-full pointer-events-none z-30">
                                <line x1={`${p.startX*5+2.5}%`} y1={`${p.startY*8.333+4.166}%`} 
                                      x2={`${p.x*5+2.5}%`} y2={`${p.y*8.333+4.166}%`} 
                                      stroke="cyan" strokeWidth="2" strokeOpacity="0.8" vectorEffect="non-scaling-stroke" />
                            </svg>
                            )
                        }
                        return (
                            <div key={p.id} className="absolute w-[1.5%] h-[2.5%] bg-white rounded-full shadow-[0_0_8px_white] z-40 transition-none border border-black/20"
                                style={{ left: `${p.x*5+2.5}%`, top: `${p.y*8.333+4.166}%`, transform: 'translate(-50%, -50%)' }}
                            />
                        )
                    })}

                    {particlesRef.current.map(p => (
                        <div key={p.id} className="absolute w-[2%] h-[3.3%] rounded-full z-20 opacity-75"
                            style={{ 
                                left: `${p.x*5+2.5}%`, top: `${p.y*8.333+4.166}%`, 
                                transform: `translate(-50%, -50%) scale(${p.life/10})`,
                                backgroundColor: p.color
                            }}
                        />
                    ))}

                    {(gameState==='menu'||gameState==='gameover'||gameState==='victory') && (
                        <div className="absolute inset-0 bg-slate-900/95 z-50 flex flex-col items-center justify-center p-8 text-center">
                            <h1 className="text-4xl md:text-5xl font-black mb-4 bg-gradient-to-r from-blue-400 to-indigo-500 bg-clip-text text-transparent">
                                {gameState==='menu'&&"香港經濟發展保衛戰"}
                                {gameState==='victory'&&"經濟發展成功！"}
                                {gameState==='gameover'&&"發展受阻..."}
                            </h1>
                            <button onClick={startGame} className="bg-indigo-600 px-8 py-3 rounded-full font-bold text-lg hover:bg-indigo-500 shadow-xl border-2 border-indigo-400 flex items-center gap-2">
                                <Play fill="currentColor" size={20}/> {gameState==='menu'?"開始挑戰 (Start)":"重試 (Retry)"}
                            </button>
                        </div>
                    )}

                    {gameState==='quiz' && (
                        <div className="absolute inset-0 bg-slate-900/95 z-50 flex items-center justify-center p-4">
                            <div className="bg-slate-800 p-6 rounded-2xl border border-slate-600 w-[90%] max-w-md text-center shadow-2xl overflow-y-auto max-h-[90vh]">
                                <h2 className="text-xl font-bold mb-4 text-yellow-400 pb-2 border-b border-slate-700">申請發展撥款 (Funding App)</h2>
                                {!feedback ? (
                                    <>
                                        <p className="text-lg font-medium mb-4">{currentQ.qZh}<br/><span className="text-xs text-slate-400">{currentQ.qEn}</span></p>
                                        <div className="grid gap-2">
                                            {currentQ.options.map((opt,i)=>(<button key={i} onClick={()=>handleQuiz(opt.c)} className="bg-slate-700 p-3 rounded-xl active:bg-blue-600 text-left font-bold border border-slate-600 text-sm hover:bg-slate-600 transition-colors">{opt.t}</button>))}
                                        </div>
                                    </>
                                ) : (
                                    <div className="text-2xl font-bold animate-bounce text-green-400 py-8">{feedback}</div>
                                )}
                            </div>
                        </div>
                    )}
                </div>
              </div>

              <div className="h-24 bg-slate-900 border-t border-slate-700 shrink-0 w-full max-w-5xl mx-auto flex items-center gap-2 p-2">
                 <div className="bg-slate-800 rounded-xl border border-slate-700 p-2 flex-1 flex items-center gap-2 overflow-x-auto no-scrollbar shadow-lg touch-pan-x h-full">
                     <div className="text-slate-500 text-[10px] font-bold w-12 text-center leading-tight flex flex-col items-center flex-shrink-0"><Hand size={16} className="mb-1"/>拖曳<br/>Drag</div>
                     <div onTouchStart={(e)=>handleDragStart('observe',e)} onMouseDown={(e)=>handleDragStart('observe',e)} className={`relative p-2 rounded-lg bg-orange-900/30 border border-orange-500/50 w-20 h-full flex flex-col items-center justify-center flex-shrink-0 ${money<100?'opacity-50':''}`}>
                         <Eye size={24} className="text-orange-400 mb-1"/><span className="text-xs font-bold text-orange-200">物流</span><span className="text-[10px] text-yellow-400">$100</span>
                     </div>
                     <div onTouchStart={(e)=>handleDragStart('hypothesis',e)} onMouseDown={(e)=>handleDragStart('hypothesis',e)} className={`relative p-2 rounded-lg bg-yellow-900/30 border border-yellow-500/50 w-20 h-full flex flex-col items-center justify-center flex-shrink-0 ${money<200?'opacity-50':''}`}>
                         <Lightbulb size={24} className="text-yellow-400 mb-1"/><span className="text-xs font-bold text-yellow-200">金融</span><span className="text-[10px] text-yellow-400">$200</span>
                     </div>
                     <div onTouchStart={(e)=>handleDragStart('experiment',e)} onMouseDown={(e)=>handleDragStart('experiment',e)} className={`relative p-2 rounded-lg bg-cyan-900/30 border border-cyan-500/50 w-20 h-full flex flex-col items-center justify-center flex-shrink-0 ${money<300?'opacity-50':''}`}>
                         <Flask size={24} className="text-cyan-400 mb-1"/><span className="text-xs font-bold text-cyan-200">創科</span><span className="text-[10px] text-yellow-400">$300</span>
                     </div>
                 </div>
                 
                 <div className="bg-slate-800 rounded-xl border border-slate-700 p-1 w-20 h-full flex flex-col justify-center gap-1 shadow-lg shrink-0">
                     {selectedTowerId ? (
                         <>
                             <button onClick={upgradeTower} disabled={money<150} className={`flex-1 bg-green-600 rounded flex flex-col items-center justify-center p-1 ${money<150?'opacity-50':''}`}><ArrowUpCircle size={16}/><span className="text-[10px] font-bold">UP</span></button>
                             <button onClick={sellTower} className="flex-1 bg-red-600 rounded flex flex-col items-center justify-center p-1"><XCircle size={16}/><span className="text-[10px] font-bold">SELL</span></button>
                         </>
                     ) : <div className="text-slate-500 text-[10px] text-center px-1">點擊建築<br/>升級</div>}
                 </div>
              </div>

              {draggedType && (
                  <div className="fixed z-50 pointer-events-none transform -translate-x-1/2 -translate-y-1/2" style={{ left: dragPos.x, top: dragPos.y - 80 }}>
                      <div className="p-3 rounded-full bg-white/30 border-2 border-white backdrop-blur shadow-xl">
                          {draggedType==='observe' && <Eye size={32} className="text-orange-500"/>}
                          {draggedType==='hypothesis' && <Lightbulb size={32} className="text-yellow-500"/>}
                          {draggedType==='experiment' && <Flask size={32} className="text-cyan-500"/>}
                      </div>
                  </div>
              )}

            </div>
          );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>